name: Move Issue to In Progress on Branch Creation

on:
  create:
    branches:
      - "*"

jobs:
  move-on-branch:
    runs-on: ubuntu-latest
    permissions:
      issues: read
      contents: read
      id-token: write

    steps:
      - name: Extract issue number from branch name
        id: extract
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          ISSUE_NUMBER=$(echo "$BRANCH_NAME" | grep -o '[0-9]\+')
          echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> $GITHUB_ENV

      - name: Move project card to In Progress
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER, 10);
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // 1. List project cards for the issue
            const { data: cards } = await github.rest.projects.listCards({
              column_id: /* You may need to list all columns first, or know project columns */,
              per_page: 100
            });

            // Actually, we should find the card via repository issue relationship
            // Better: list all project cards for the repositoryâ€™s project and filter by content_id = issue.id

            // 2. Find the card for this issue
            const issue = await github.rest.issues.get({
              owner,
              repo,
              issue_number: issueNumber
            });

            // Fetch all cards in all columns of your project:
            const projectId = /* YOUR PROJECT ID */;
            const { data: columns } = await github.rest.projects.listColumns({
              project_id: projectId
            });

            let cardToMove = null;
            for (const col of columns) {
              const { data: colCards } = await github.rest.projects.listCards({
                column_id: col.id,
                per_page: 100
              });
              const found = colCards.find(c => c.content_url && c.content_url.endsWith(`/issues/${issueNumber}`));
              if (found) {
                cardToMove = found;
                break;
              }
            }

            if (!cardToMove) {
              core.setFailed(`No project card found for issue #${issueNumber}`);
              return;
            }

            // 3. Move the card
            const inProgressColumn = columns.find(c => c.name === "In Progress");
            if (!inProgressColumn) {
              core.setFailed(`Column "In Progress" not found in project`);
              return;
            }

            await github.rest.projects.moveCard({
              card_id: cardToMove.id,
              position: "top",
              column_id: inProgressColumn.id
            });

            console.log(`Moved card for issue #${issueNumber} to column In Progress`);
