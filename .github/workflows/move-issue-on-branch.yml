name: Move Issue to In Progress on Branch Creation

on:
  create:
    branches:
      - "*"

jobs:
  move_issue:
    runs-on: ubuntu-latest
    permissions:
      issues: read
      contents: read
      project: write

    steps:
      - name: Extract issue number from branch name
        id: extract
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          ISSUE_NUMBER=$(echo "$BRANCH_NAME" | grep -o '[0-9]\+')
          echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> $GITHUB_ENV

      - name: Move project card to In Progress
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER, 10);
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // 1. List all columns of your project
            const projectId = 7;
            const { data: columns } = await github.rest.projects.listColumns({
              project_id: projectId
            });

            // 2. Find the "In Progress" column
            const inProgress = columns.find(c => c.name === "In Progress");
            if (!inProgress) {
              core.setFailed('In Progress column not found');
              return;
            }

            // 3. Find the card for this issue
            let cardToMove = null;
            for (const col of columns) {
              const { data: cards } = await github.rest.projects.listCards({
                column_id: col.id,
                per_page: 100
              });
              const found = cards.find(c => c.content_url && c.content_url.endsWith(`/issues/${issueNumber}`));
              if (found) {
                cardToMove = found;
                break;
              }
            }

            if (!cardToMove) {
              core.setFailed(`No project card found for issue #${issueNumber}`);
              return;
            }

            // 4. Move the card
            await github.rest.projects.moveCard({
              card_id: cardToMove.id,
              column_id: inProgress.id,
              position: "top"
            });

            console.log(`Moved issue #${issueNumber} to In Progress`);
